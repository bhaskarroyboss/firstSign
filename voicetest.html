<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Voice Test - Improved</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-6">

  <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg text-center">
      <img src="logo.jpg" alt="Stroke Detection Logo" class="h-16 mx-auto" />
    <h1 class="text-2xl font-bold mb-6">Voice Test</h1>
    <p class="mb-6">Please say the following phrase clearly:</p>
    <p class="mb-6 text-indigo-700 font-semibold text-lg">"I am feeling fine today"</p>

    <button id="startBtn" class="bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700 transition mb-6">
      Start Test
    </button>

    <p id="status" class="text-gray-700 mb-4"></p>

    <p><strong>Transcript:</strong> <span id="transcript"></span></p>

    <div id="results" class="hidden mt-4 text-left">
      <p>Similarity Score: <span id="similarityScore"></span>%</p>
      <p>Recognition Confidence: <span id="confidenceScore"></span>%</p>
      <p>Speech Duration: <span id="durationTime"></span> seconds</p>
      <p><strong>Stroke Speech Score:</strong> <span id="strokeSpeechScore"></span>%</p>
    </div>

    <button id="nextBtn" disabled class="bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 transition mt-6">
      Next
    </button>
  </div>

<script>
  const phrase = "I am feeling fine today";
  const startBtn = document.getElementById('startBtn');
  const status = document.getElementById('status');
  const transcriptElem = document.getElementById('transcript');
  const similarityElem = document.getElementById('similarityScore');
  const confidenceElem = document.getElementById('confidenceScore');
  const durationElem = document.getElementById('durationTime');
  const strokeSpeechScoreElem = document.getElementById('strokeSpeechScore');
  const resultsDiv = document.getElementById('results');
  const nextBtn = document.getElementById('nextBtn');

  let recognition;
  let startTime, endTime;

  function levenshtein(a, b) {
    const dp = Array.from({length: a.length + 1}, () => Array(b.length + 1).fill(0));
    for(let i = 0; i <= a.length; i++) dp[i][0] = i;
    for(let j = 0; j <= b.length; j++) dp[0][j] = j;

    for(let i = 1; i <= a.length; i++) {
      for(let j = 1; j <= b.length; j++) {
        if(a[i-1] === b[j-1]) dp[i][j] = dp[i-1][j-1];
        else dp[i][j] = 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
      }
    }
    return dp[a.length][b.length];
  }

  startBtn.addEventListener('click', () => {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      alert('Speech Recognition API not supported in this browser.');
      return;
    }

    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    startBtn.disabled = true;
    transcriptElem.textContent = '';
    status.textContent = 'Listening... Please say: "' + phrase + '"';
    resultsDiv.classList.add('hidden');
    nextBtn.disabled = true;
    startTime = performance.now();

    recognition.start();

    recognition.onresult = (event) => {
      endTime = performance.now();
      const spokenText = event.results[0][0].transcript.trim();
      const confidence = event.results[0][0].confidence;

      transcriptElem.textContent = spokenText + ` (Confidence: ${(confidence*100).toFixed(1)}%)`;

      // Calculate Levenshtein distance normalized similarity
      const dist = levenshtein(spokenText.toLowerCase(), phrase.toLowerCase());
      const maxLen = Math.max(spokenText.length, phrase.length);
      const similarity = ((maxLen - dist) / maxLen) * 100;

      // Calculate speech duration (in seconds)
      const duration = (endTime - startTime) / 1000;

      // Load baseline voice data
      const baselineRaw = localStorage.getItem('voiceBaseline');
      if(!baselineRaw) {
        alert('No baseline voice data found! Please register first.');
        startBtn.disabled = false;
        return;
      }
      const baseline = JSON.parse(baselineRaw);

      // Compute differences for scoring:
      // Similarity difference (lower similarity means higher risk)
      const simDiff = Math.max(0, baseline.similarity - similarity);

      // Confidence difference (lower confidence could mean unclear speech)
      const confDiff = Math.max(0, baseline.confidence - confidence);

      // Duration difference (if test is slower, penalty)
      const durDiff = Math.max(0, duration - baseline.duration);

      // Weighted stroke speech score: higher difference = higher risk
      // Normalize to 0-100 scale roughly
      const strokeSpeechScore = Math.min(
        100,
        (simDiff * 1.5 + confDiff * 1.2 + durDiff * 10) * 10
      ).toFixed(2);

      similarityElem.textContent = similarity.toFixed(2);
      confidenceElem.textContent = (confidence * 100).toFixed(2);
      durationElem.textContent = duration.toFixed(2);
      strokeSpeechScoreElem.textContent = strokeSpeechScore;

      // Save stroke speech score
      localStorage.setItem('voiceTestScore', strokeSpeechScore);

      status.textContent = 'Test complete.';
      resultsDiv.classList.remove('hidden');
      nextBtn.disabled = false;
    };

    recognition.onerror = (event) => {
      status.textContent = 'Error: ' + event.error;
      startBtn.disabled = false;
    };
  });

  nextBtn.addEventListener('click', () => {
    window.location.href = 'accelerometertest.html'; // or next page
  });
</script>

</body>
</html>
